function [P,P1,P2] = Example3_LMI (A,alfa,fi,xv,b,LM,eps,b1,b2,mu,be)
%% This script needs the instalation of toolboxes YALMIP and SEDUMI to solve the LMIs
fi_0_11_12=fi(1);
fi_0_11_11= fi(2);
fi_1_11_11= fi(3);
fi_1_11_12= fi(4);
fi_1_21_22=fi(5);
fi_1_21_21= fi(6);
fi_1_21_21= fi(7);
fi_1_21_22= fi(8);

% Number of subsystems and local models of switched system (5)
[Ns,ri] = size(A);
nA = size(A{1,1},2);  % Dimension of matrices A_pk

% Creating the matricial variables
M= sdpvar(2*nA,2*nA,'symmetric');
P=cell(Ns,ri);
P1=cell(Ns,ri);
P2=cell(Ns,ri);
R=cell(Ns,ri);
L=cell(Ns,ri);
for i1=1:Ns
    for i2=1:ri
       P{i1,i2} = sdpvar(nA,nA,'symmetric');
       P1{i1,i2} = sdpvar(nA,nA,'symmetric');
       P2{i1,i2} = sdpvar(nA,nA,'symmetric');
       R{i1,i2} = sdpvar(nA,nA,'full');
       L{i1,i2} = sdpvar(nA,nA,'full');
    end
end

% Creating variables \Upsilon_{pk-ij}
Ga=cell(Ns,ri,Ns,ri);
for la=1:Ns
 for ca=1:ri
  for lp=1:Ns
   for cp=1:ri
     a11=alfa(la)*(L{lp,cp}*A{la,ca}+A{la,ca}'*L{lp,cp}')+...
                      ((eps)/Ns)*P1{lp,cp}-(eps*LM/(Ns*b1*b^2))*eye(nA);
     a21=(1/Ns)*P{lp,cp}-(1/Ns)*L{lp,cp}'+alfa(la)*(R{lp,cp}*A{la,ca});
     a22=(1/Ns)*(-R{lp,cp}-R{lp,cp}');
     Ga{lp,cp,la,ca}=[a11 a21';a21 a22];
   end
  end
 end
end

e1=[1;0]; e2=[0;1]; % Bounding level curve \Omega_1
%% Taking into account the following sets: G1={2,4} e G2={2,4}
Qalfa = Ga{1,2,1,2}+Ga{1,4,1,4}+Ga{2,2,2,2}+Ga{2,4,2,4}+M;
% Theorem 2 - LMI (38)
Restr = [P1{1,2}+P2{1,2}-P{1,2}>=0 ...
         P1{1,4}+P2{1,4}-P{1,4}>=0 ...
         P1{2,2}+P2{2,2}-P{2,2}>=0 ...
         P1{2,4}+P2{2,4}-P{2,4}>=0];

% Theorem 2 - LMI (19)
Restr = [Restr ...
         P{1,2}-mu*eye(2)<=0 P{1,4}-mu*eye(2)<=0 ...
         P{2,2}-mu*eye(2)<=0 P{2,4}-mu*eye(2)<=0];

% Theorem 2 - LMI (20)
Restr = [Restr ...
         P{1,2}-((e1*e1')/(xv^2))>=0 P{1,2}-((e2*e2')/(xv^2))>=0 ...
         P{1,4}-((e1*e1')/(xv^2))>=0 P{1,4}-((e2*e2')/(xv^2))>=0 ...
         P{2,2}-((e1*e1')/(xv^2))>=0 P{2,2}-((e2*e2')/(xv^2))>=0 ...
         P{2,4}-((e1*e1')/(xv^2))>=0 P{2,4}-((e2*e2')/(xv^2))>=0];

if be<2
% Theorem 2 - LMI (11)
    Restr = [Restr Ga{1,2,1,2}+Qalfa<=0 Ga{1,4,1,4}+Qalfa<=0];

% Theorem 2 - LMI (12)
    Restr = [Restr Ga{1,1,1,2}+Qalfa<=0 Ga{1,1,1,4}+Qalfa<=0 ...
                   Ga{1,3,1,2}+Qalfa<=0 Ga{1,3,1,4}+Qalfa<=0 ...
                   Ga{1,1,2,2}+Qalfa<=0 Ga{1,1,2,4}+Qalfa<=0 ...
                   Ga{1,3,2,2}+Qalfa<=0 Ga{1,3,2,4}+Qalfa<=0];

% Theorem 2 - LMI (13)
    Restr = [Restr Ga{1,2,1,4}+Ga{1,4,1,2}+2*Qalfa<=0];

% Theorem 2 - LMI (14)
    Restr = [Restr Ga{2,2,2,2}-Qalfa<=0 Ga{2,4,2,4}-Qalfa<=0];

% Theorem 2 - LMI (15)
    Restr = [Restr Ga{2,1,1,2}-Qalfa<=0 Ga{2,1,1,4}-Qalfa<=0 ...
                   Ga{2,1,2,2}-Qalfa<=0 Ga{2,1,2,4}-Qalfa<=0 ...
                   Ga{2,3,1,2}-Qalfa<=0 Ga{2,3,1,4}-Qalfa<=0 ...
                   Ga{2,3,2,2}-Qalfa<=0 Ga{2,3,2,4}-Qalfa<=0];

% Theorem 2 - LMI (16)
    Restr = [Restr Ga{2,2,2,4}+Ga{2,4,2,2}-2*Qalfa<=0];

% Theorem 2 - LMI (17) - Empty set

% Theorem 2 - LMI (18)
    Restr = [Restr Ga{1,2,2,2}+Ga{2,2,1,2}<=0 ...
                   Ga{1,2,2,4}+Ga{2,4,1,2}<=0 ...
                   Ga{1,4,2,2}+Ga{2,2,1,4}<=0 ...
                   Ga{1,4,2,4}+Ga{2,4,1,4}<=0];
else
% Theorem 2 - LMI (11)
    Restr = [Restr Ga{2,2,2,2}+Qalfa<=0 Ga{2,4,2,4}+Qalfa<=0];

% Theorem 2 - LMI (12)
    Restr = [Restr Ga{2,1,1,2}+Qalfa<=0 Ga{2,1,1,4}+Qalfa<=0 ...
                   Ga{2,1,2,2}+Qalfa<=0 Ga{2,1,2,4}+Qalfa<=0 ...
                   Ga{2,3,1,2}+Qalfa<=0 Ga{2,3,1,4}+Qalfa<=0 ...
                   Ga{2,3,2,2}+Qalfa<=0 Ga{2,3,2,4}+Qalfa<=0];

% Theorem 2 - LMI (13)
    Restr = [Restr Ga{2,2,2,4}+Ga{2,4,2,2}+2*Qalfa<=0];

% Theorem 2 - LMI (14)
    Restr = [Restr Ga{1,2,1,2}-Qalfa<=0 Ga{1,4,1,4}-Qalfa<=0];

% Theorem 2 - LMI (15)
    Restr = [Restr Ga{1,1,1,2}-Qalfa<=0 Ga{1,1,1,4}-Qalfa<=0 ...
                   Ga{1,1,2,2}-Qalfa<=0 Ga{1,1,2,4}-Qalfa<=0 ...
                   Ga{1,3,1,2}-Qalfa<=0 Ga{1,3,1,4}-Qalfa<=0 ...
                   Ga{1,3,2,2}-Qalfa<=0 Ga{1,3,2,4}-Qalfa<=0];

% Theorem 2 - LMI (16)
    Restr = [Restr Ga{1,2,1,4}+Ga{1,4,1,2}-2*Qalfa<=0];

% Theorem 2 - LMI (17) - Empty set

% Theorem 2 - LMI (18)
    Restr = [Restr Ga{2,2,1,2}+Ga{1,2,2,2}<=0 ...
                   Ga{2,2,1,4}+Ga{1,4,2,2}<=0 ...
                   Ga{2,4,1,2}+Ga{1,2,2,4}<=0 ...
                   Ga{2,4,1,4}+Ga{1,4,2,4}<=0];
end

% Theorem 2 - LMI (31)
 Restr = [Restr...
(alfa(1)*(fi_0_11_11*abs(A{1,1}(1,1))+fi_0_11_12*abs(A{1,1}(1,2)))*P{1,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)+P2{1,2}/(Ns*b2)<=0 ...
(alfa(1)*(fi_0_11_11*abs(A{1,2}(1,1))+fi_0_11_12*abs(A{1,2}(1,2)))*P{1,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(1)*(fi_0_11_11*abs(A{1,3}(1,1))+fi_0_11_12*abs(A{1,3}(1,2)))*P{1,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(1)*(fi_0_11_11*abs(A{1,4}(1,1))+fi_0_11_12*abs(A{1,4}(1,2)))*P{1,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_0_11_11*abs(A{2,1}(1,1))+fi_0_11_12*abs(A{2,1}(1,2)))*P{1,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_0_11_11*abs(A{2,2}(1,1))+fi_0_11_12*abs(A{2,2}(1,2)))*P{1,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_0_11_11*abs(A{2,3}(1,1))+fi_0_11_12*abs(A{2,3}(1,2)))*P{1,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_0_11_11*abs(A{2,4}(1,1))+fi_0_11_12*abs(A{2,4}(1,2)))*P{1,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(1)*(fi_1_11_11*abs(A{1,1}(1,1))+fi_1_11_12*abs(A{1,1}(1,2)))*P{1,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)+P2{1,4}/(Ns*b2)<=0 ...
(alfa(1)*(fi_1_11_11*abs(A{1,2}(1,1))+fi_1_11_12*abs(A{1,2}(1,2)))*P{1,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(1)*(fi_1_11_11*abs(A{1,3}(1,1))+fi_1_11_12*abs(A{1,3}(1,2)))*P{1,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(1)*(fi_1_11_11*abs(A{1,4}(1,1))+fi_1_11_12*abs(A{1,4}(1,2)))*P{1,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_1_11_11*abs(A{2,1}(1,1))+fi_1_11_12*abs(A{2,1}(1,2)))*P{1,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_1_11_11*abs(A{2,2}(1,1))+fi_1_11_12*abs(A{2,2}(1,2)))*P{1,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_1_11_11*abs(A{2,3}(1,1))+fi_1_11_12*abs(A{2,3}(1,2)))*P{1,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_1_11_11*abs(A{2,4}(1,1))+fi_1_11_12*abs(A{2,4}(1,2)))*P{1,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(1)*(fi_0_11_11*abs(A{1,1}(1,1))+fi_0_11_12*abs(A{1,1}(1,2)))*P{2,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)+P2{2,2}/(Ns*b2)<=0 ...
(alfa(1)*(fi_0_11_11*abs(A{1,2}(1,1))+fi_0_11_12*abs(A{1,2}(1,2)))*P{2,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(1)*(fi_0_11_11*abs(A{1,3}(1,1))+fi_0_11_12*abs(A{1,3}(1,2)))*P{2,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(1)*(fi_0_11_11*abs(A{1,4}(1,1))+fi_0_11_12*abs(A{1,4}(1,2)))*P{2,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_0_11_11*abs(A{2,1}(1,1))+fi_0_11_12*abs(A{2,1}(1,2)))*P{2,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_0_11_11*abs(A{2,2}(1,1))+fi_0_11_12*abs(A{2,2}(1,2)))*P{2,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_0_11_11*abs(A{2,3}(1,1))+fi_0_11_12*abs(A{2,3}(1,2)))*P{2,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_0_11_11*abs(A{2,4}(1,1))+fi_0_11_12*abs(A{2,4}(1,2)))*P{2,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(1)*(fi_1_11_11*abs(A{1,1}(1,1))+fi_1_11_12*abs(A{1,1}(1,2)))*P{2,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)+P2{2,4}/(Ns*b2)<=0 ...
(alfa(1)*(fi_1_11_11*abs(A{1,2}(1,1))+fi_1_11_12*abs(A{1,2}(1,2)))*P{2,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(1)*(fi_1_11_11*abs(A{1,3}(1,1))+fi_1_11_12*abs(A{1,3}(1,2)))*P{2,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(1)*(fi_1_11_11*abs(A{1,4}(1,1))+fi_1_11_12*abs(A{1,4}(1,2)))*P{2,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_1_11_11*abs(A{2,1}(1,1))+fi_1_11_12*abs(A{2,1}(1,2)))*P{2,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_1_11_11*abs(A{2,2}(1,1))+fi_1_11_12*abs(A{2,2}(1,2)))*P{2,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_1_11_11*abs(A{2,3}(1,1))+fi_1_11_12*abs(A{2,3}(1,2)))*P{2,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_1_11_11*abs(A{2,4}(1,1))+fi_1_11_12*abs(A{2,4}(1,2)))*P{2,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(1)*(fi_1_21_21*abs(A{1,1}(2,1))+fi_1_21_22*abs(A{1,1}(2,2)))*P{1,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)+P2{1,2}/(Ns*b2)<=0 ...
(alfa(1)*(fi_1_21_21*abs(A{1,2}(2,1))+fi_1_21_22*abs(A{1,2}(2,2)))*P{1,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(1)*(fi_1_21_21*abs(A{1,3}(2,1))+fi_1_21_22*abs(A{1,3}(2,2)))*P{1,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(1)*(fi_1_21_21*abs(A{1,4}(2,1))+fi_1_21_22*abs(A{1,4}(2,2)))*P{1,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_1_21_21*abs(A{2,1}(2,1))+fi_1_21_22*abs(A{2,1}(2,2)))*P{1,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_1_21_21*abs(A{2,2}(2,1))+fi_1_21_22*abs(A{2,2}(2,2)))*P{1,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_1_21_21*abs(A{2,3}(2,1))+fi_1_21_22*abs(A{2,3}(2,2)))*P{1,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_1_21_21*abs(A{2,4}(2,1))+fi_1_21_22*abs(A{2,4}(2,2)))*P{1,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(1)*(fi_1_21_21*abs(A{1,1}(2,1))+fi_1_21_22*abs(A{1,1}(2,2)))*P{1,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)+P2{1,4}/(Ns*b2)<=0 ...
(alfa(1)*(fi_1_21_21*abs(A{1,2}(2,1))+fi_1_21_22*abs(A{1,2}(2,2)))*P{1,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(1)*(fi_1_21_21*abs(A{1,3}(2,1))+fi_1_21_22*abs(A{1,3}(2,2)))*P{1,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(1)*(fi_1_21_21*abs(A{1,4}(2,1))+fi_1_21_22*abs(A{1,4}(2,2)))*P{1,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_1_21_21*abs(A{2,1}(2,1))+fi_1_21_22*abs(A{2,1}(2,2)))*P{1,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_1_21_21*abs(A{2,2}(2,1))+fi_1_21_22*abs(A{2,2}(2,2)))*P{1,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_1_21_21*abs(A{2,3}(2,1))+fi_1_21_22*abs(A{2,3}(2,2)))*P{1,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_1_21_21*abs(A{2,4}(2,1))+fi_1_21_22*abs(A{2,4}(2,2)))*P{1,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(1)*(fi_1_21_21*abs(A{1,1}(2,1))+fi_1_21_22*abs(A{1,1}(2,2)))*P{2,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)+P2{2,2}/(Ns*b2)<=0 ...
(alfa(1)*(fi_1_21_21*abs(A{1,2}(2,1))+fi_1_21_22*abs(A{1,2}(2,2)))*P{2,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(1)*(fi_1_21_21*abs(A{1,3}(2,1))+fi_1_21_22*abs(A{1,3}(2,2)))*P{2,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(1)*(fi_1_21_21*abs(A{1,4}(2,1))+fi_1_21_22*abs(A{1,4}(2,2)))*P{2,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_1_21_21*abs(A{2,1}(2,1))+fi_1_21_22*abs(A{2,1}(2,2)))*P{2,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_1_21_21*abs(A{2,2}(2,1))+fi_1_21_22*abs(A{2,2}(2,2)))*P{2,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_1_21_21*abs(A{2,3}(2,1))+fi_1_21_22*abs(A{2,3}(2,2)))*P{2,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_1_21_21*abs(A{2,4}(2,1))+fi_1_21_22*abs(A{2,4}(2,2)))*P{2,2})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(1)*(fi_1_21_21*abs(A{1,1}(2,1))+fi_1_21_22*abs(A{1,1}(2,2)))*P{2,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)+P2{2,4}/(Ns*b2)<=0 ...
(alfa(1)*(fi_1_21_21*abs(A{1,2}(2,1))+fi_1_21_22*abs(A{1,2}(2,2)))*P{2,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(1)*(fi_1_21_21*abs(A{1,3}(2,1))+fi_1_21_22*abs(A{1,3}(2,2)))*P{2,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(1)*(fi_1_21_21*abs(A{1,4}(2,1))+fi_1_21_22*abs(A{1,4}(2,2)))*P{2,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_1_21_21*abs(A{2,1}(2,1))+fi_1_21_22*abs(A{2,1}(2,2)))*P{2,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_1_21_21*abs(A{2,2}(2,1))+fi_1_21_22*abs(A{2,2}(2,2)))*P{2,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_1_21_21*abs(A{2,3}(2,1))+fi_1_21_22*abs(A{2,3}(2,2)))*P{2,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0 ...
(alfa(2)*(fi_1_21_21*abs(A{2,4}(2,1))+fi_1_21_22*abs(A{2,4}(2,2)))*P{2,4})-(eps*LM/(Ns*b2*b^2))*eye(nA)<=0];

% Setting LMI solver
opts=sdpsettings;
% opts.solver='lmilab';
 opts.solver='sedumi';
opts.verbose=0;
% Solving LMIs
sol = solvesdp(Restr,[],opts);
p=min(checkset(Restr));
if p > 0
    % Obtaining numerical values of matrices P_pk, P1_pk and P2_pk
    for i1=1:Ns
        for i2=1:ri
            P{i1,i2} = double(P{i1,i2});
            P1{i1,i2} = double(P1{i1,i2});
            P2{i1,i2} = double(P2{i1,i2});
        end
    end
else
    display('Unfeasible LMIs')
    P=[];
    P1=[];
    P2=[];
end
